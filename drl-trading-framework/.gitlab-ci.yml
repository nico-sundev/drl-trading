stages:
  - lint
  - test
  - coverage
  - build

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.uv-cache"
  UV_VENV_PATH: "$CI_PROJECT_DIR/.venv"
  PYTEST_ADDOPTS: "--color=yes"
  MIN_COVERAGE_THRESHOLD: "80"  # Set minimum coverage threshold to 80%

cache:
  paths:
    - .pip-cache/
    - .uv-cache/
    - .venv/
    - .mypy_cache/
    - .ruff_cache/

# Template for Python jobs
.python-job:
  image: python:3.12
  before_script:
    - python --version
    - pip install uv
    - uv --version
    - uv venv
    - source .venv/bin/activate
    - uv pip install -e ".[testing,dev]"

# Linting stage
ruff:
  extends: .python-job
  stage: lint
  script:
    - uv pip install ruff
    - ruff check src tests

# mypy:
#   extends: .python-job
#   stage: lint
#   script:
#     - uv pip install mypy
#     - mypy src

# Testing stages
unit-tests:
  extends: .python-job
  stage: test
  script:
    - pytest tests/unit -v

integration-tests:
  extends: .python-job
  stage: test
  script:
    - pytest tests/it -v

# benchmark-tests:
#   extends: .python-job
#   stage: test
#   script:
#     - pytest tests/benchmarks -v
#   # Mark benchmarks as optional as they're usually for information
#   allow_failure: true
#   rules:
#     - if: '$CI_PIPELINE_SOURCE == "schedule" || $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main"'

# Code coverage
coverage:
  extends: .python-job
  stage: coverage
  script:
    # No need to install pytest and pytest-cov again as they're already part of [testing] extras
    - pytest --cov=drl_trading_framework --cov-report=xml --cov-report=html --cov-report=term --cov-fail-under=${MIN_COVERAGE_THRESHOLD} tests/
  after_script:
    - echo "Coverage threshold set to ${MIN_COVERAGE_THRESHOLD}%"
    - |
      if [ -f coverage.xml ]; then
        COVERAGE=$(python -c "import xml.etree.ElementTree as ET; print(ET.parse('coverage.xml').getroot().get('line-rate'))")
        COVERAGE_PCT=$(python -c "print(round(float('${COVERAGE}') * 100, 2))")
        echo "Total coverage: ${COVERAGE_PCT}%"

        if (( $(echo "${COVERAGE_PCT} < ${MIN_COVERAGE_THRESHOLD}" | bc -l) )); then
          echo "Coverage ${COVERAGE_PCT}% is below threshold of ${MIN_COVERAGE_THRESHOLD}%"
          exit 1
        else
          echo "Coverage ${COVERAGE_PCT}% meets or exceeds threshold of ${MIN_COVERAGE_THRESHOLD}%"
        fi
      else
        echo "No coverage report found"
        exit 1
      fi
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
      - htmlcov/  # HTML coverage report for detailed analysis
    expire_in: 1 week
  coverage: '/Total coverage: (\d+\.\d+)%/'

# Build package
build:
  extends: .python-job
  stage: build
  script:
    - uv pip install build
    - python -m build
  artifacts:
    paths:
      - dist/*.whl
      - dist/*.tar.gz
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG'
